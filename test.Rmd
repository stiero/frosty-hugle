---
title: "R Notebook"
output: html_notebook
---


```{r}
rm(list=ls())
setwd("/home/tauro/Projects/quizziz")

library(jsonlite)
library(lubridate)
library(dplyr)
library(ggplot2)
#library(reshape2)
#library(purrr)

options(scipen=999)
```

```{r}
data <- stream_in(file("data_role_assignment.json"))
```
Some data preprocessing

```{r}
params <- lapply(data$params, "[[", 2)
params <- setNames(do.call(rbind.data.frame, params), 
                       c("sessionId", "page", "userId"))

data$params <- NULL

data <- cbind(data, params)

rm(params)


data$serverTime <- ymd_hms(data$serverTime, tz="UTC")

data$day <- day(data$serverTime) 
data$month <- month(data$serverTime)
data$hour <- hour(data$serverTime)
data$wday <- wday(data$serverTime, label=TRUE)

categorical_cols <- c("version", "eventId", "sessionId", "page", "userId", "day",
                      "month", "hour", "wday")

data$wday <- as.factor(as.character(data$wday))

data[categorical_cols] <- lapply(data[categorical_cols], factor)

#Filling in missing userIds for the same session
data <- data %>% group_by(sessionId) %>% mutate("userId" = first(userId))

data$is_reg <- as.factor(as.integer(is.na(data$userId)))
```
  
<br />

### Number of events (n_events)

The first metric we look at is the number of events. Here, *n_events* is the number of events for a particular session. 
```{r}
#Number of events per session across both versions
eventsPerSessionAB <- data %>% select(everything()) %>% 
  group_by(sessionId, version, is_reg) %>% summarise("n_events" = length(eventId)) %>% 
  arrange(desc(n_events)) 

eventsPerSessionAB
```
<br />
  
Testing for normality of *n_events* through a random sample (Shapiro's test)
```{r}
shapiro.test(sample(eventsPerSessionAB$n_events, 3000))
#Cannot assume normality, hence not ideal to perform t-test directly

```
  
  
  
<br />
The results clearly show conclusive evidence against the null hypothesis (that *n_events* is normally distributed)
  
  
Usually, one performs a two-sample Student's t-test of the means of two populations. But since the t-test assumes the data to be normally distributed and our data indicates otherwise, we need an alternative. 
  
  
We perform the Mann-Whitney-Wilcox test which does not assume normality.

1) n_events grouped by version


```{r}
wilcox.test(n_events ~ version, data=eventsPerSessionAB)

```
The number of events for both versions are not identically distributed

<br />
2) n_events grouped by registration status  

```{r}
wilcox.test(n_events ~ is_reg, data=eventsPerSessionAB)

```
The number of events for registered and non_registered sessions are not identically distributed
  
Based on the results of the Mann-Whitney-Wilcox test, we can conclude that the differences in *n_events* by version and registered status are statistically significant

<br />

Plotting n_events by version

```{r}
ggplot(eventsPerSessionAB, aes(x=version, y=n_events, fill=version)) + 
  geom_bar(stat="identity")
```

<br />

Now we look at the mean number of events per session across both versions (including bounces)


```{r}
mean_eventsPerSessionAB_inc_bounce <- eventsPerSessionAB  %>% group_by(version) %>% 
  summarise("mean_n_events" = mean(n_events))

mean_eventsPerSessionAB_inc_bounce
```

```{r}
ggplot(mean_eventsPerSessionAB_inc_bounce, aes(x=version, y=mean_n_events, fill=version)) + geom_bar(stat="identity")

```
Similarly we look at the mean number of events per session across both versions (excluding bounces)

```{r}
mean_eventsPerSessionAB_exc_bounce <- eventsPerSessionAB %>% filter(n_events > 1) %>% 
  group_by(version) %>% summarise("mean_n_events" = mean(n_events))

mean_eventsPerSessionAB_exc_bounce
```
```{r}
ggplot(mean_eventsPerSessionAB_exc_bounce, aes(x=version, y=mean_n_events, fill=version)) + geom_bar(stat="identity")

```
Here, we can see that version B generates more number of events and consequently has a higher number of mean events. 


<br />

### Bounce rate
Now we look at a second metric, the bounce rate (bounce_rate), which is the proportion of sessions that ended after landing on one page only.

Has a session bounced or not? Flagging 1 for 'yes' and 0 for 'no'.

```{r}
bounced_yesno <- data %>% select(everything()) %>% 
  group_by(sessionId, version, is_reg) %>% summarise("n_events" = length(eventId)) %>% 
  mutate("bounced" = as.integer(!n_events == 1)) %>% ungroup() %>%
  select(sessionId, bounced)

bounced_yesno$bounced <- as.factor(bounced_yesno$bounced)

bounced_yesno
```
```{r}
ggplot(bounced_yesno, aes(x=bounced, fill=bounced)) + geom_bar(stat="count")
```


```{r}
bounce_rate <- eventsPerSessionAB %>% filter(n_events == 1) %>% group_by(version) %>%
  summarise("bounce_rate" = 100 * (length(n_events)/length(eventsPerSessionAB$n_events)))

bounce_rate
```
```{r}
ggplot(bounce_rate, aes(x=version, y=bounce_rate, fill=version)) + 
  geom_bar(stat="identity")
```
We see that version A has a much higher bounce rate. 



